<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    html {
        width: 100%;
        height: 100%;
    }

    body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-image: url("../img/background.png");
        background-position: 100% 100%;
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
</style>
<script src="../glitterBundle/ControlInstance.js"></script>
<body>
<h3 style="font-weight:400;letter-spacing: 3px;text-align: center;color: white;margin-left: 10px;font-size: 50px;">𝒫𝑒𝓉𝒶𝑔𝓇𝒶𝓂</h3>
</body>
</html>
<script>
    function switchPage() {
        glitter.dataBase.init("Md_User",function (){
            glitter.serialUtil.getObject("md_user","Md_User",function (userData){
                console.log("Md_User=="+userData)
                if (userData !== 'NA' && userData !== undefined) {
                    glitter.publicBeans.account = userData.account
                    login(userData.account, userData.password)
                  //  login("sam38124", "sam28520")
                } else {
                    login("guest", "12345")
                   // login("sam38124", "sam28520")
                }
            },function (){
                switchPage()
            })
        },function (){
            switchPage()
        })
    }
    setTimeout(switchPage, 3000)

    //登入換頁
    function login(admin, password) {
        let json = {}
        json.request = "login"
        json.account = admin
        json.password = password
        glitter.publicBeans.postRequest(json, function (data) {
            glitter.closeDiaLogWithTag('SignIn')
            var mapData = JSON.parse(data)
            if (mapData.result === "true") {
                glitter.publicBeans.token = mapData.token
                var dat = JSON.parse(mapData.data)
                glitter.md_user = dat
                var map = {}
                map.account = dat.account
                map.password = dat.password
                glitter.serialUtil.storeObject(map,"md_user","Md_User",function (){
                    glitter.publicBeans.requestAllApi()
                    checkReturnUrl()
                },function (){
                    glitter.openDiaLog('dialog/Dia_DisConnect.html', 'DisConnect', false, false, function () {
                        login(admin, password)
                    })
                })
            } else {
                glitter.setHome('page/Page_Sign_In.html', 'Page_Sign_In', '{}')
            }
        }, function (data) {
            glitter.openDiaLog('dialog/Dia_DisConnect.html', 'DisConnect', false, false, function () {
                login(admin, password)
            })
        })
    }

    /**
     * 判斷是否要跳轉至returnurl
     * */
    function checkReturnUrl() {
        if (gBundle.searchParams.get('returnVideo') !== null) {
            goVideo()
        } else if (gBundle.searchParams.get('returnGroup') !== null) {
            goGroup()
        } else if(gBundle.searchParams.get('returnArticle') !== null){
            goArticle()
        }else if(gBundle.searchParams.get('returnCommodity') !== null){
            goCommodity()
        }else {
            if(glitter.getBoundingClientRect.width>768){
                glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
            }else{
                glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
            }
        }
    }
    /**
     * 取得文章
     * */
    function goArticle(){
        glitter.publicBeans.postRequest({
            request: 'getArticleById',
            account: glitter.md_user.account,
            id: gBundle.searchParams.get('returnArticle')
        }, function (res) {
            var result = JSON.parse(res)
            if (result.result === 'true') {
                var item = JSON.parse(result.data)
                if (item.length === 1) {
                    item[0].isReturnUrl = true
                    glitter.setHome('page/Page_Show_Article.html', 'Page_Show_Article', item[0])
                }else{
                    if(glitter.getBoundingClientRect.width>768){
                        glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                    }else{
                        glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                    }
                }
            } else {
                if(glitter.getBoundingClientRect.width>768){
                    glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                }else{
                    glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                }
            }
        }, function () {
            goArticle()
        })
    }
    /**
     * 取得影片
     * */
    function goVideo() {
        glitter.publicBeans.postRequest({
            request: 'getVideoByID',
            account: glitter.md_user.account,
            id: gBundle.searchParams.get('returnVideo')
        }, function (res) {
            var result = JSON.parse(res)
            if (result.result === 'true') {

                var item = JSON.parse(result.data)
                if (item.length === 1) {
                    item[0].isReturnUrl = true
                    glitter.setHome('page/Page_Show_Video.html', 'Page_Show_Video', item[0])
                }
            } else {
                if(glitter.getBoundingClientRect.width>768){
                    glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                }else{
                    glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                }
            }
        }, function () {
            goVideo()
        })
    }

    /**
     * 取得揪團
     * */
    function goGroup() {
        glitter.publicBeans.postRequest({
            request: 'getGroupById',
            account: glitter.md_user.account,
            id: gBundle.searchParams.get('returnGroup')
        }, function (res) {
            var result = JSON.parse(res)
            if (result.result === 'true') {
                var item = JSON.parse(result.data)
                if (item.length === 1) {
                    item[0].isReturnUrl = true
                    glitter.setHome('page/Page_Show_Group.html', 'Page_Show_Group', item[0])
                }
            } else {
                if(glitter.getBoundingClientRect.width>768){
                    glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                }else{
                    glitter.setHome('page/Page_Hone2.html', 'Page_Home', '{}')
                }
            }
        }, function () {
            goGroup()
        })
    }
    /**
     * 取得揪團
     * */
    function goCommodity() {
        glitter.publicBeans.postRequest({
            request: 'getCommodityById',
            account: glitter.md_user.account,
            id: gBundle.searchParams.get('returnCommodity')
        }, function (res) {
            let result = JSON.parse(res)
            if (result.result === 'true') {
                let item = JSON.parse(result.data)
                if (item.length === 1) {
                    item[0].isReturnUrl = true
                    glitter.setHome('page/Page_Show_Shopping.html', 'Page_Show_Shopping', item[0])
                }else{
                    glitter.openDiaLog('dialog/Dia_Info.html', 'Dia_Info', false, true, `此商品已被刪除!!`)
                }
            } else {
                glitter.openDiaLog('dialog/Dia_Info.html', 'Dia_Info', false, true, `發生錯誤，請稍後再試!!`)
            }
        }, function () {
            goCommodity()
        })
    }

    //收藏
    function postSubF() {
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        glitter.openDiaLog('dialog/Dia_DataLoading.html', 'post', false, false, '{}')
        postFSub(gBundle.id, function (result) {
            glitter.closeDiaLog('post')
            if (result === 'error') {
                glitter.openDiaLog('dialog/Dia_DisConnect.html', 'DisConnect', false, false, function () {
                })
            } else {
                if (result.result === 'true') {
                    if (result.data === "-1") {
                        $('#subBt').css('fill', 'rgba(0, 0, 0, 0.2)')
                    } else {
                        $('#subBt').css('fill', 'dodgerblue')
                    }
                }
            }
        })
    }

</script>