<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script src="../glitterBundle/ControlInstance.js"></script>
<script src="../glitterBundle/src/TouchDragListener.js"></script>
<style>
    html {
        width: 100%;
        height: 100%;
    }

    body {
        display: flex;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        flex-direction: column;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    video {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    .contentList {
        display: flex;
        flex-direction: column;
        overflow-y: hidden;
    }

    .contentList .tit {
        margin: 10px;
        color: black;
        font-weight: 600;
        font-size: 20px;
    }

    .reader {
        color: hsla(0, 0%, 6.7%, .6);
        font-size: 13px;
        margin-top: 0;
        margin-left: 10px;
    }

    .imgItem {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 50px;
        margin-top: 10px;
    }

    .imgItem svg {
        width: 30px;
        height: 30px;
    }

    .imgItem h3 {
        color: #6a6a6a;
        font-size: 13px;
        margin-top: 5px;
    }

    .clickList {
        width: calc(100% - 20px);
        height: 70px;
        margin-left: 10px;
        margin-right: 10px;
        justify-content: space-around;
        display: flex;
    }

    #loveBt {
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .spi {
        height: 1px;
        background-color: hsla(0, 0%, 53.3%, .4);
        width: 100%;
    }

    .adminPlace {
        display: flex;
        height: 50px;
        margin-left: 10px;
        margin-right: 10px;
        align-items: center;

    }

    .adminPlace img {
        width: 30px;
        height: 30px;
        border-radius: 15px;
    }

    .content {
        padding: 10px;
        font-weight: 600;
        color: gray;
        font-size: 14px;

    }

    .topbar .left {
        width: calc(100% - 40px);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .topbar {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
</style>
<link href="../css/Reply.css" rel="stylesheet">
<script src="../model/Md_Reply_Message.js"></script>
<link rel="stylesheet" href="../css/CVideo_Cell.css">
<script src="../jslib/lottie.js"></script>
<script src="../glitterBundle/GlAdapter.js"></script>
<body>
</body>
</html>
<script>
    //console.log("影片內容" + JSON.stringify(gBundle))
    var isReturnUrl = gBundle.isReturnUrl
    lifeCycle.onCreateView = function () {
        return `<div id="topBar" style="height: 48px;display: flex;width: 100%;background-color: dodgerblue;align-items: center;">
<img src="../img/btn_back_normal.png" style="width: 40px;height: 40px;" onclick="${(isReturnUrl) ? `glitter.publicBeans.toLocalPage()`:'glitter.goBack()'}">
<h3 style="color: white;font-weight: 800;margin-left: 10px;font-size: 16px;">影像</h3>
<div style="flex: auto;"></div>
${(glitter.md_user.account===gBundle.account) ? `<div style="width: 25px;height: 25px;margin-right: 10px;" onclick="more()">
        <svg viewBox="0 0 24 24" focusable="false" role="img" aria-hidden="true" class="ite" style="fill: white;">
            <g transform="translate(148)">
                <circle cx="2" cy="2" r="2" transform="translate(-138 4)"></circle>
                <circle cx="2" cy="2" r="2" transform="translate(-138 10)"></circle>
                <circle cx="2" cy="2" r="2" transform="translate(-138 16)"></circle>
            </g>
        </svg>
    </div>`:``}
</div>`  + publicBeans.getVideoView(gBundle, 'width:  100%; height:57vw;background-color: black;margin: 0;border-radius: 0;',true) + `
   <div id="scrollView" style="margin-top:-50px;height:calc(100% - 57vw);overflow-y: scroll;width: 100%;">
   <div style="height: 50px;"></div>
    <div class="contentList">
    <div class="topbar" onclick="toggleContent()">
    <div class="left">
      <h3 class="tit">` + glitter.unicodeToString(gBundle.title) + `</h3>
   <h3 class="reader">觀看次數：${gBundle.reader}</h3>
</div>
  <div  class="imgItem" >
     <div id="toggleImg" style="cursor:pointer;fill: black;position: relative;z-index: 2;transform: translateY(-15px)"  >
       <svg viewBox="0 0 24 24" fill=""><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"></path></svg>
    </div>
   </div>
</div>

   <div class="clickList">
   <div class="imgItem">
     <div style="cursor:pointer;fill: ${(gBundle.isLike === 'false') ? 'gray' : 'deeppink'};position: relative;z-index: 2;"  onclick="addLove()" id="loveBt">
        <svg viewBox="0 0 24 24" focusable="false" role="img" aria-hidden="true" class="ite" id="heartBt">
            <path d="M16.5 4A5.49 5.49 0 0012 6.344 5.49 5.49 0 007.5 4 5.5 5.5 0 002 9.5C2 16 12 22 12 22s10-6 10-12.5A5.5 5.5 0 0016.5 4z"
                  fill-rule="evenodd"></path>
        </svg>
    </div>
   <h3 id="goodCount">${gBundle.good}</h3>
</div>
<div class="imgItem">
     <div style="cursor:pointer;fill:${(gBundle.isSub === 'false') ? 'gray' : 'dodgerblue'};position: relative;z-index: 2;"  id="subBt" onclick="addSub()">
        <svg viewBox="0 0 24 24" focusable="false" role="img" aria-hidden="true" class="ite" id="subBt">
            <path d="M17.65 21.39L12 17.5l-5.65 3.88A1.5 1.5 0 014 20.15V5a2.5 2.5 0 012.5-2.5h11A2.5 2.5 0 0120 5v15.15a1.5 1.5 0 01-2.35 1.24z"></path>
        </svg>
    </div>
   <h3 id="subHint">${(gBundle.isSub === 'false') ? '收藏' : '已收藏'}</h3>
</div>
<div class="imgItem" onclick="share()">
     <div style="cursor:pointer;fill: grey;position: relative;z-index: 2;"  id="loveBt">
       <svg viewBox="0 0 24 24" fill=""><path d="M14 9V5l7 7-7 7v-4.1c-5 0-8.5 1.6-11 5.1 1-5 4-10 11-11z"></path></svg>
    </div>
   <h3>分享</h3>
</div>
<div class="imgItem">
  <div style="cursor:pointer;fill: grey;position: relative;z-index: 2;"  id="reportBt" onclick="glitter.openDiaLog('dialog/Dia_Report.html','Dia_Report',false,true,gBundle.id)">
     <svg viewBox="0 0 24 24" fill=""><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"></path></svg>
    </div>
   <h3>檢舉</h3>
</div>
</div>
<div class="spi"></div>
<div  class="adminPlace">
<img onclick="glitter.publicBeans.goUserInfo('${gBundle.account}')" src="` + gBundle.head + `">
<div style="display: flex;flex-direction: column;height: 100%;justify-content: center;margin-left: 10px;">
<h3 style="font-weight:400;color: black;font-size: 14px;margin: 0;" onclick="glitter.publicBeans.goUserInfo('${gBundle.account}')">` + glitter.unicodeToString(gBundle.pick) + `</h3>
<h3 style="font-weight:200;color: black;font-size: 11px;opacity: .6;margin: 0;">${gBundle.subCount}人訂閱</h3>
</div>
<div style="flex: auto;"></div>
<div id="haveSubScrible" onclick="toSubscriber()" style="font-weight:600;color: red;margin-right:10px;font-size: 16px;display: flex;align-items: center;justify-content: center;">訂閱</div>
</div>
<div class="spi"></div>
<div id="contentText" class="content" style="">${glitter.unicodeToString(gBundle.content)}
</div>
<div class="spi"></div>
<div id="videoList" style="margin-left: 10px;margin-right: 10px;display: flex;flex-direction: column;margin-top: 10px;">
<h3 style="color: black;font-size: 16px;margin-left: 5px;margin-top: 0;">其他影片</h3>
</div>
</div>
<div style="width: 100%;height: 1px;background-color:hsla(0, 0%, 53.3%, .4); "></div>
<div style="background-color: white;height: 50px;display: flex;align-items: center;cursor: pointer;" onclick="toggleMessage()">
<h3 id='replyCount' style="color: black;font-size: 16px;margin-left: 10px;">留言．${gBundle.replyCount}則</h3>
<div style="flex: auto;"></div>
 <div  id="toggleMessage" style="cursor:pointer;fill: black;width: 30px;margin-right: 10px;transform: translateY(5px)"  >
<svg viewBox="0 0 24 24" fill=""><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg>
 </div>
</div>

<div style="display: flex;align-items: center;">
    <img class="head" src="${glitter.md_user.head}" style="margin-left: 20px;width: 30px;height: 30px;border-radius: 15px;">
<h3 style="color: #808080;font-size: 14px;margin-left: 10px;flex: auto;"
    onclick="replyArticle()">
    撰寫回應...</h3>
</div>
<div style="width: 100%;height: 1px;background-color:hsla(0, 0%, 53.3%, .4); "></div>
<div id="messageList" style="display: flex;align-items: center;flex-direction: column;padding-top: 10px;">
</div>
</div>
<input style="display: none;" type="text" value="${glitter.publicBeans.domain}/Petagram/home?returnVideo=${gBundle.id}" id="myInput">

    `
    }

    var toggleBol = true

    function toggleContent() {
        toggleBol = !toggleBol
        if (toggleBol) {
            $('#toggleImg').html('<svg viewBox="0 0 24 24" fill=""><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"></path></svg>')
            $('#contentText').show()
        } else {
            $('#toggleImg').html('<svg viewBox="0 0 24 24" fill=""><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg>')
            $('#contentText').hide()
        }
    }

    var toggleMessagei=true
    function toggleMessage(){
        toggleMessagei = !toggleMessagei
        if(toggleMessagei){
            $('#toggleMessage').html('<svg viewBox="0 0 24 24" fill=""><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"></path></svg>')
            $('#messageList').show()
        }else{
            $('#toggleMessage').html('<svg viewBox="0 0 24 24" fill=""><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg>')
            $('#messageList').hide()
        }
    }
    var lastY=0
    var scrollPos=0
    lifeCycle.onCreate = function () {
       glitter.addScrollListener($('#scrollView'),{
           position:function (y){
               if(y<0){return}
               scrollPos+=(y-lastY)
               if(scrollPos>50){scrollPos=50}
               if(scrollPos<0){scrollPos=0}
               $('#topBar').css('transform',`translateY(${-scrollPos}px)`)
               $('#hls-video').css('transform',`translateY(${-scrollPos}px)`)
               lastY=y
           }
        })
         messageItem = []
         messageAdapter = new GlAdapter(document.getElementById('messageList'), function () {
            return messageItem.length
        }, function (position) {
            var id = messageItem[position].id
            var pick = glitter.unicodeToString(messageItem[position].pick)
            var content = JSON.parse('{"unicode":"' + messageItem[position].content + '"}').unicode
            var like = messageItem[position].like
            var time = messageItem[position].time
            var replyCount = messageItem[position].replyCount
            //判斷有無按讚
            var mlike=messageItem[position].mLike
            var html = ''

            html += `  <div style="width: calc(100% - 30px);height: 100%;margin-top: 0;margin-bottom: 0;">
        <div class="flexBar" style="margin-bottom: 0;">
            <img class="head" onclick="glitter.publicBeans.goUserInfo('${messageItem[position].account}')"
                 src="${messageItem[position].head}">
            <div class="rightContent">
                <h3 onclick="onclick="glitter.publicBeans.goUserInfo('${messageItem[position].account}')" class="pickText">${pick}</h3>
                <h3 class="messageText">${content}</h3>
            </div>
        </div>
        <div class="btFlex" style="margin-left: 40px;margin-top: 0px;">
            <h3 class="btText">${time}</h3>
            <h3 class="btText" style="color:${(mlike === "1") ? "dodgerblue" : "gray"} " id="message${id}" onclick="postMessageLike('${id}',${position})">${(like === 0) ? '' : (like + '個')}讚</h3>
            <h3 class="btText" onclick="replyMessage(${position})">${(replyCount === 0) ? "回覆" : replyCount + "則回覆"}</h3>
        </div>
    </div>`
            return html
        })
        startGetReply()
        addReader()
        checkSubscriber()
        getPromoteVideo()
    }

    /**分享連結*/
    function share() {
        glitter.publicBeans.share($('#myInput'),document)
    }

    /**添加觀看次數*/
    function addReader() {
        glitter.publicBeans.postRequest({
            request: 'addReader',
            account: glitter.md_user.account,
            id: gBundle.id
        }, function () {

        }, function () {
            addReader()
        })
    }

    /**按讚*/
    function addLove() {
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        glitter.publicBeans.postWithDialog({
            request: 'postCVLike',
            account: glitter.md_user.account,
            id: gBundle.id
        }, function () {
            gBundle.isLike = (gBundle.isLike === 'true') ? 'false' : 'true'
            gBundle.good = (gBundle.isLike === 'false') ? parseInt(gBundle.good, 10)- 1 : parseInt(gBundle.good , 10)+ 1
            $('#loveBt').css('fill', `${(gBundle.isLike === 'false') ? 'gray' : 'deeppink'}`)
            $('#goodCount').html(gBundle.good)
        }, function () {
        })
    }

    /**收藏*/
    function addSub() {
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        glitter.publicBeans.postWithDialog({
            request: 'postCVSub',
            account: glitter.md_user.account,
            id: gBundle.id
        }, function () {
            gBundle.isSub = (gBundle.isSub === 'true') ? 'false' : 'true'
            $('#subBt').css('fill', `${(gBundle.isSub === 'false') ? 'gray' : 'dodgerblue'}`)
            $('#subHint').html(`${(gBundle.isSub === 'false') ? '收藏' : '已收藏'}`)
        }, function () {
        })
    }

    /**訂閱**/
    function toSubscriber() {
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        glitter.publicBeans.postWithDialog({
            request: 'toSubscriber',
            account: glitter.md_user.account,
            toAccount: gBundle.account
        }, function () {
            haveSubscriber = !haveSubscriber
            $('#haveSubScrible').html((haveSubscriber) ? "已訂閱" : "訂閱")
        }, function () {
        })
    }

    /**檢查有無訂閱此用戶**/
    var haveSubscriber = false

    function checkSubscriber() {
        glitter.publicBeans.postWithDialog({
            request: 'checkSubscriber',
            account: glitter.md_user.account,
            toAccount: gBundle.account
        }, function (data) {
            var result = JSON.parse(data)
            if (result.result === 'true') {
                if (result.data === '1') {
                    haveSubscriber = true
                    $('#haveSubScrible').html("已訂閱")
                } else {
                    haveSubscriber = false
                    $('#haveSubScrible').html("訂閱")
                }
            } else {
                checkSubscriber()
            }
        }, function () {

        })
    }

    /**取得推薦影片**/
    var listVideo = []

    function getPromoteVideo() {
        $('#videoList').html(`
<h3 style="color: black;font-size: 16px;margin-left: 5px;margin-top: 0;">其他影片</h3>
<div id="loadingView" style="height: 100px; width: 100%;text-align: center;vertical-align: middle;">
    <lottie-player src="../lottieFile/loading.json"  background="transparent"  speed="1"  style="position:relative;width: 50px; height: 50px;transform: translateX(-50%);left: 50%;"  loop  autoplay></lottie-player>
    <br>
    <h1 style="font-size: 13px;color: gray;margin-top: -20px;">加載中...</h1>
</div>`)
        glitter.publicBeans.postRequest({
            request: 'getPromoteVideo',
            account: glitter.md_user.account
        }, function (res) {
            var result = JSON.parse(res)
            if (result.result === 'true') {
                var item = JSON.parse(result.data)
                listVideo = listVideo.concat(item)
                var listVideoHtml=`<h3 style="color: black;font-size: 16px;margin-left: 5px;margin-top: 0;">其他影片</h3>`
                for (var i = 0; i < item.length; i++) {
                    var data = item[i]
                    if (data.id === gBundle.id) {
                        continue
                    }
                    listVideoHtml+=`
            <div style="display: flex;margin-bottom: 10px;" onclick="changeVideoView(${i})">
<img src="${ data.videoLink}thumb.jpg" style="width: 160px;height:90px;">
<div style="display: flex;flex-direction: column;width: calc(100% - 160px);">
<h3 style="margin-left:5px;font-size: 14px;overflow:hidden;text-overflow:ellipsis;font-weight: 500;margin-top:0;margin-bottom:0;display: -webkit-box;-webkit-line-clamp: 3;-webkit-box-orient: vertical;white-space: normal;">${glitter.unicodeToString(data.title)}</h3>
<div style="flex: auto;"></div>
<span style="margin-left:5px;font-size: 13px;opacity: .6;margin-top: 0px;">${glitter.unicodeToString(data.pick)}</span>
<span style="margin-left:5px;font-size: 11px;opacity: .6;margin-top: 0px;">觀看次數:${data.reader}次</span>
</div>
</div>
            `
                }
                $('#videoList').html(listVideoHtml)
            }

        }, function () {
            getPromoteVideo()
        })
    }

    function changeVideoView(i) {
        gBundle = listVideo[i]
        $('body').html(lifeCycle.onCreateView())
        lifeCycle.onCreate()
    }



    /**
    * 留言
    * */
    var messageItem=[]
    var messageAdapter=undefined
    //回覆留言
    function replyArticle(){
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        glitter.openBottomSheet('page/Page_Post_Message.html','Page_Post_Message',{id:'Vd'+gBundle.id,callBack:function (){
                gBundle.replyCount=parseInt(gBundle.replyCount,10)+1
                $('#replyCount').html(`留言．${gBundle.replyCount}則`)
            },bottomSheet:true},"100%",false)
    }
    //回覆留言中的留言
    function replyMessage(position) {
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        var articleId="Vd"+gBundle.id
        var replyMap={}
        replyMap.articleId=articleId
        replyMap.data=messageItem[position]
        replyMap.height=$(document).height()
        glitter.openBottomSheet('dialog/Dia_ReplyMessage.html','Dia_ReplyMessage',replyMap,replyMap.height)
    }
    //留言按讚
    function postMessageLike(id, position) {
        if(glitter.md_user.account==='guest'){
            glitter.openDiaLog('dialog/Dia_Need_Sign_In.html','Dia_Need_Sign_In',false,true,{},()=>{})
            return
        }
        glitter.openDiaLog('dialog/Dia_DataLoading.html', 'post', false, false, '{}')
        messageInterFace.postLike(id, 'Vd' + gBundle.id, function (result) {
            glitter.closeDiaLog('post')
            if (result === 'error') {
                glitter.openDiaLog('dialog/Dia_DisConnect.html', 'DisConnect', false, false, function () {
                })
            } else {
                if (result.result === 'true') {
                    if (result.data === "-1") {
                        messageItem[position].like=messageItem[position].like-1
                        var html=((messageItem[position].like === 0) ? '' : (messageItem[position].like + '個'))+'讚'
                        $('#message' + id).css("color","gray")
                        $('#message' + id).html(html)
                    } else {
                        messageItem[position].like=messageItem[position].like+1
                        $('#message' + id).css("color","dodgerblue")
                        $('#message' + id).html( messageItem[position].like +'個讚')
                    }
                }
            }
        })
    }
    //取得回覆訊息
    function startGetReply() {
        messageInterFace.getMessage('Vd' + gBundle.id, function (result) {
            if (result === 'error') {
                startGetReply()
            } else {
                if (result.result === 'true') {
                    messageItem = JSON.parse(result.data)
                    messageAdapter.notifyDataSetChange()
                } else {
                    startGetReply()
                }
            }
        })
    }

    function more(){
        glitter.openDiaLog('dialog/Dia_Item_Selection.html','Dia_Item_Selection',false,true,[
            {title:'刪除影片',callback:function (){
  glitter.publicBeans.postWithDialog({
      request:'deleteVideo',
      id:gBundle.id
  },function (result){
      result=JSON.parse(result)
      if(result.result==='true'){
          glitter.openDiaLog('dialog/Dia_Info.html','Dia_Info',false,true,"影片刪除成功",function (){
              glitter.publicBeans.userVideoModel.data=glitter.publicBeans.userVideoModel.data.filter(function (data){return  data.id!==gBundle.id})
              setTimeout(function (){glitter.goBack()},100)
          })
      }else{
          glitter.openDiaLog('dialog/Dia_Info.html','Dia_Info',false,true,"沒有刪除此影片的權限",function (){})
      }
  },function (){})
                }}
        ]);
    }
</script>